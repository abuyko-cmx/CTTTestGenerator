<?xml version="1.0" encoding="UTF-8"?>

<!--Generated by CTT Stubs Editor 17.01.18 12:58-->
<stubMQ xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://ctt.cinimex.ru/stubMQ.xsd" queueIn="ESB_2_BIS_ENTRY" queueOut="BIS_2_ESB_ASYNC_TEST" lookupTimeout="1000" name="bq_stub" language="groovy" theadPoolSize="7">
  <connectionPool timeout="3600000" maxConnections="115" maxUnusedConnections="30"/>
  <queueManagers>
    <queueManager name="QM2" host="rshb-08.vm.cmx.ru" channel="SYSTEM.DEF.SVRCONN" readEncoding="UTF-8" writeEncoding="UTF-8" user="" password="" port="1415" ccsid="1208">
      <queue name="ESB_2_BIS_ENTRY_103" objName="ESB_2_BIS_ENTRY"/>
      <queue name="BIS_2_ESB_ASYNC_TEST" objName="BIS_2_ESB_ASYNC_TEST"/>
    </queueManager>
  </queueManagers>
  <logConfig level="ALL" writeMessages="true" memoryStore="false"/>
  <global name="global">
    <request>
      <content><![CDATA[]]></content>
    </request>
    <response name="response_BQ"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<!--Sample XML file generated by XMLSpy v2014 rel. 2 sp1 (x64) (http://www.altova.com)-->
<GetCreditDetailsHistoryResponse xmlns="http://www.rshb.ru/csm/pro/ocrmfl/rel1/credit/get_credit_details_history/201502/resp">
	<Error>
		<ErrorCode>0</ErrorCode>
	</Error>
	<Loan>
		<AgreementID>
			<ObjectId>BQ</ObjectId>
			<SystemId>25g2g25h</SystemId>
			<SystemNodeId>25h25h25h2</SystemNodeId>
		</AgreementID>
		<FilialID>
			<ObjectId>h245h25h</ObjectId>
			<SystemId>25h25h245h</SystemId>
			<SystemNodeId>b5537n573</SystemNodeId>
		</FilialID>
		<ListOfLoanHistory>
			<LoanHistory>
				<AttributeName>2g5g25h2</AttributeName>
				<PreviousValue>g254h245h2</PreviousValue>
				<NewValue>g254gh2h6jw</NewValue>
				<ChangeDate>1955-08-13</ChangeDate>
				<EmployeeName>g525h24nh2nh</EmployeeName>
				<EmployeeNumber>235g245h26</EmployeeNumber>
			</LoanHistory>
			<LoanHistory>
				<AttributeName>245b246n53</AttributeName>
				<PreviousValue>b2526n563</PreviousValue>
				<NewValue>b245b26n3n</NewValue>
				<ChangeDate>1900-08-13</ChangeDate>
				<EmployeeName>g 25g 25 25h</EmployeeName>
				<EmployeeNumber> 25y 262 y26</EmployeeNumber>
			</LoanHistory>
		</ListOfLoanHistory>
	</Loan>
</GetCreditDetailsHistoryResponse>
]]></response>
    <response name="tc_bisq_BQ"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<tr:message xmlns:tr="http://bis.ru/transport" fromBranch="${from_branch_resp}" fromSystem="${from_system_resp}" operation="${operation}" pass="${pass}" service="${service}" toBranch="${to_branch_resp}" toSystem="${to_system_resp}" userDirect="${userDirect}">
 <tr:parameters>
  <tr:param>
   <tr:name>DATA</tr:name>
   <tr:num>1</tr:num>
   <tr:type>DATASET</tr:type>
   <tr:value>${inf_obj}</tr:value>
   <tr:format>CODED</tr:format>
  </tr:param>
 </tr:parameters>
</tr:message>]]></response>
    <response name="error_BQ"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<!--Sample XML file generated by XMLSpy v2014 rel. 2 sp1 (x64) (http://www.altova.com)-->
<GetCreditDetailsHistoryResponse xmlns="http://www.rshb.ru/csm/pro/ocrmfl/rel1/credit/get_credit_details_history/201502/resp">
	<Error>
		<ErrorCode>999</ErrorCode>
		<ErrorText>BQ Error</ErrorText>
	</Error>
	<Loan>
		<AgreementID>
			<ObjectId>BQ</ObjectId>
			<SystemId>25g2g25h</SystemId>
			<SystemNodeId>25h25h25h2</SystemNodeId>
		</AgreementID>
		<FilialID>
			<ObjectId>h245h25h</ObjectId>
			<SystemId>25h25h245h</SystemId>
			<SystemNodeId>b5537n573</SystemNodeId>
		</FilialID>
		<ListOfLoanHistory>
			<LoanHistory>
				<AttributeName>2g5g25h2</AttributeName>
				<PreviousValue>g254h245h2</PreviousValue>
				<NewValue>g254gh2h6jw</NewValue>
				<ChangeDate>1955-08-13</ChangeDate>
				<EmployeeName>g525h24nh2nh</EmployeeName>
				<EmployeeNumber>235g245h26</EmployeeNumber>
			</LoanHistory>
			<LoanHistory>
				<AttributeName>245b246n53</AttributeName>
				<PreviousValue>b2526n563</PreviousValue>
				<NewValue>b245b26n3n</NewValue>
				<ChangeDate>1900-08-13</ChangeDate>
				<EmployeeName>g 25g 25 25h</EmployeeName>
				<EmployeeNumber> 25y 262 y26</EmployeeNumber>
			</LoanHistory>
		</ListOfLoanHistory>
	</Loan>
</GetCreditDetailsHistoryResponse>
]]></response>
    <response name="skip_BQ"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<!--Sample XML file generated by XMLSpy v2014 rel. 2 sp1 (x64) (http://www.altova.com)-->
<GetCreditDetailsHistoryResponse xmlns="http://www.rshb.ru/csm/pro/ocrmfl/rel1/credit/get_credit_details_history/201502/resp">
	<Error>
		<ErrorCode>val2</ErrorCode>
		<ErrorText>BQ skip</ErrorText>
	</Error>
	<Loan>
		<AgreementID>
			<ObjectId>BQBQBQ4r12f14g135g</ObjectId>
		</AgreementID>
		<FilialID>
			<ObjectId>1r213gb526</ObjectId>
		</FilialID>
	</Loan>
</GetCreditDetailsHistoryResponse>]]></response>
    <response name="two_BQ"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<!--Sample XML file generated by XMLSpy v2014 rel. 2 sp1 (x64) (http://www.altova.com)-->
<GetCreditDetailsHistoryResponse xmlns="http://www.rshb.ru/csm/pro/ocrmfl/rel1/credit/get_credit_details_history/201502/resp">
	<Error>
		<ErrorCode>0</ErrorCode>
	</Error>
	<Loan>
		<AgreementID>
			<ObjectId>BQ</ObjectId>
			<SystemId>25g2g25h</SystemId>
			<SystemNodeId>25h25h25h2</SystemNodeId>
		</AgreementID>
		<FilialID>
			<ObjectId>h245h25h</ObjectId>
			<SystemId>25h25h245h</SystemId>
			<SystemNodeId>b5537n573</SystemNodeId>
		</FilialID>
		<ListOfLoanHistory>
			<LoanHistory>
				<AttributeName>2g5g25h2</AttributeName>
				<PreviousValue>g254h245h2</PreviousValue>
				<NewValue>g254gh2h6jw</NewValue>
				<ChangeDate>1955-08-13</ChangeDate>
				<EmployeeName>g525h24nh2nh</EmployeeName>
				<EmployeeNumber>235g245h26</EmployeeNumber>
			</LoanHistory>
			<LoanHistory>
				<AttributeName>245b246n53</AttributeName>
				<PreviousValue>b2526n563</PreviousValue>
				<NewValue>b245b26n3n</NewValue>
				<ChangeDate>1900-08-13</ChangeDate>
				<EmployeeName>g 25g 25 25h</EmployeeName>
				<EmployeeNumber> 25y 262 y26</EmployeeNumber>
			</LoanHistory>
		</ListOfLoanHistory>
	</Loan>
</GetCreditDetailsHistoryResponse>]]></response>
    <response name="empty_BQ"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<!--Sample XML file generated by XMLSpy v2014 rel. 2 sp1 (x64) (http://www.altova.com)-->
<GetCreditDetailsHistoryResponse xmlns="http://www.rshb.ru/csm/pro/ocrmfl/rel1/credit/get_credit_details_history/201502/resp">
	<Error>
		<ErrorCode>0</ErrorCode>
	</Error>
</GetCreditDetailsHistoryResponse>
]]></response>
    <script name="global" type="main"><![CDATA[	import com.ibm.mq.MQMessage;

//Получаем заголовки
	MQMessage msgIn = contextRequest.getRequest().getNativeMessage();
	MQMessage msgOut = new MQMessage();

// Получаем данные из входящего сообщения
	c_JMSMessageID = msgIn.getStringProperty("c_JMSMessageID");
	c_GUID = msgIn.getStringProperty("c_GUID");

	request = contextRequest.getRequest().toString();
    message = new XmlSlurper(false,true).parseText(request);
    inf_obj_req = message.'**'.find { node-> node.name() == 'value'}.text();

	to_branch_req = message.@toBranch;
	from_branch_req = message.@fromBranch;
	from_system_req = message.@fromSystem
	to_system_req = message.@toSystem
	operation = message.@operation;
	pass = message.@pass;
	service = message.@service;

	rootNode = new XmlSlurper(false,true).parseText(inf_obj_req);
	client_id = rootNode.'**'.find {it.name()  == 'AgreementID'}.ObjectId.toInteger();

//Логика работы заглушки
	tc_bisq = "tc_bisq_BQ";

	def empty_list = [10004];
	def skip_list = [10008];
	def error_list = [10013]; 

	if (client_id in error_list) {
		inf_obj_template = "error_BQ"
	} else if (client_id in skip_list) {
		inf_obj_template = "skip_BQ"
	} else if (client_id == 10015) {
		inf_obj_template = "two_BQ"
	} else if (client_id in empty_list) {
		inf_obj_template = "empty_BQ"
	} else {
		inf_obj_template = "response_BQ";
	}

//Подготавливаем ответ
	response = contextResponse.getTemplate(tc_bisq);
	inf_obj = contextResponse.getTemplate(inf_obj_template); 
	response.setParam("inf_obj", inf_obj.toString(), "ESCAPE");
	response.setParam("to_branch_resp", from_branch_req.toString());
	response.setParam("from_branch_resp", to_branch_req.toString());
	response.setParam("from_system_resp", to_system_req.toString());
	response.setParam("to_system_resp", from_system_req.toString());
	response.setParam("service", service.toString());
	response.setParam("operation", operation.toString());
	response.setParam("pass", pass.toString());
	response.setParam("userDirect", "ANSWER");

	msgOut.setStringProperty("c_CorrelationSet", c_JMSMessageID);
	msgOut.setStringProperty("c_GUID_CORR", c_GUID);
	msgOut.format = com.ibm.mq.MQC.MQFMT_STRING;
	msgOut.characterSet = 1208;
	msgOut.writeString(response.toString());
	mqUtils.send("BIS_2_ESB_ASYNC_TEST", msgOut);]]></script>
  </global>
</stubMQ>
