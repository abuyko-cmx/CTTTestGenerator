<?xml version="1.0" encoding="UTF-8"?>

<!--Generated by CTT Stubs Editor 11.01.18 18:34-->
<stubMQ xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://ctt.cinimex.ru/stubMQ.xsd" queueIn="ESB_2_SYS2_ADAPTER_QUEUE" queueOut="IIB.CFTADP.CRT.IN" lookupTimeout="1000" name="cft_stub" language="groovy" theadPoolSize="10">
  <connectionPool timeout="3600000" maxConnections="115" maxUnusedConnections="30"/>
  <queueManagers>
    <queueManager name="QM2" host="rshb-08.vm.cmx.ru" channel="SYSTEM.DEF.SVRCONN" readEncoding="UTF-8" writeEncoding="UTF-8" user="" password="" port="1415" ccsid="1208">
      <queue name="ESB_2_SYS2_ADAPTER_QUEUE_104" objName="ESB_2_SYS2_ADAPTER_QUEUE"/>
      <queue name="IIB.CFTADP.CRT.IN" objName="IIB.CFTADP.CRT.IN"/>
    </queueManager>
  </queueManagers>
  <logConfig level="ALL" writeMessages="true" memoryStore="false"/>
  <global name="global">
    <request>
      <content><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<inc:operation xmlns:inc="http://rshb/transport/interface" 
xmlns:env="http://rshb/transport/envelope" xmlns:sec="http://rshb/transport/security">
	<input>
		<env:Header>
			<env:FromSystem>#{fromSystem}</env:FromSystem>
			<env:ToSystem>#{toSystem}</env:ToSystem>
			<env:Direction>REQUEST</env:Direction>
			<env:FromBranch>#{FromBranch}</env:FromBranch>
			<env:ToBranch>#{ToBranch}</env:ToBranch>
			<env:Interaction>ASYNC</env:Interaction>
			<env:Service>#{service}</env:Service>
		</env:Header>
		<env:Message>#{value}</env:Message>
		<env:Result Status="Success"/>
		<env:Extention>
			<env:name>JMSMessageID</env:name>
			<env:value>ID:bbb2778cf62111e7b899c0a80ef100000000000000000000</env:value>
		</env:Extention>
		<env:Extention>
			<env:name>JMSMessageGUID</env:name>
			<env:value>#{message_id}</env:value>
		</env:Extention>
		<env:Extention>
			<env:name>Direction</env:name>
			<env:value>REQUEST</env:value>
		</env:Extention>
	</input>
</inc:operation>]]></content>
    </request>
    <response name="tc_cft"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<inc:operation xmlns:inc="http://rshb/transport/interface" xmlns:env="http://rshb/transport/envelope" xmlns:sec="http://rshb/transport/security">
	<input>
		<env:Header>
			<env:FromSystem>${fromSystem}</env:FromSystem>
			<env:ToSystem>${toSystem}</env:ToSystem>
			<env:Direction>ANSWER</env:Direction>
			<env:FromBranch>${FromBranch}</env:FromBranch>
			<env:ToBranch>${ToBranch}</env:ToBranch>
			<env:Interaction>ASYNC</env:Interaction>
			<env:Service>${service}</env:Service>
		</env:Header>
		<env:Message>${inf_obj}</env:Message>
		<env:Result Status="Success"/>
		<env:Extention>
			<env:name>JMSMessageID</env:name>
			<env:value>${message_id}</env:value>
		</env:Extention>
		<env:Extention>
			<env:name>JMSMessageGUID</env:name>
			<env:value>${corr_id}</env:value>
		</env:Extention>
		<env:Extention>
			<env:name>Direction</env:name>
			<env:value>ANSWER</env:value>
		</env:Extention>
		<env:MacInfo _isMacCorrect="1">
			<sec:_hmac>String</sec:_hmac>
			<sec:_signerId>String</sec:_signerId>
			<sec:_secretKeyId>String</sec:_secretKeyId>
			<sec:algorithmName>String</sec:algorithmName>
			<sec:macDatetime>2001-12-17T09:30:47Z</sec:macDatetime>
			<sec:signer>String</sec:signer>
		</env:MacInfo>
	</input>
</inc:operation>]]></response>
    <response name="response"></response>
    <response name="error"></response>
    <response name="error_1"></response>
    <response name="without_io"></response>
    <response name="without_bd"></response>
    <script name="global" type="main"><![CDATA[import com.ibm.mq.MQMessage;
import org.apache.commons.lang.RandomStringUtils;
MQMessage msgOut = new MQMessage();
msgOut.format = com.ibm.mq.MQC.MQFMT_STRING;
msgOut.characterSet = 1208;


//генерируем новый MessageId
MessageId_random = UUID.randomUUID().toString()

//объявил inf_obj_template
String inf_obj_template = "global_inf_obj_template";

//вытащим всю информацию
String message_id = contextRequest.getRequest().getParam("message_id");
String fromBranch = contextRequest.getRequest().getParam("FromBranch");
String toBranch = contextRequest.getRequest().getParam("ToBranch");
String fromSystem = contextRequest.getRequest().getParam("fromSystem");
String toSystem = contextRequest.getRequest().getParam("toSystem");
String service = contextRequest.getRequest().getParam("service");

//проверка, какой id пришел
def io_req = contextRequest.getRequest().getParam("value", "ESCAPE");
io_req = new XmlSlurper(false,true).parseText(io_req);
check_id = io_req.GetCreditPaymentsSchedule.FilialID.ObjectId.text() as Integer;

//получены все бизнес - данные
if (check_id ==  1001 || check_id ==  1004 || check_id ==  1008 || check_id ==  1009  )
	inf_obj_template = "response";

else if(check_id ==  1008)
	inf_obj_template = "error_1";

else if(check_id ==  1009)
	inf_obj_template = "error";	

else if(check_id ==  2006)
{
	inf_obj_template = "response";	
	sleep(15000);
}

else if(check_id ==  2007)
	inf_obj_template = "without_bd";	

else if(check_id ==  2008)
	inf_obj_template = "without_io";	

response = contextResponse.getTemplate("tc_cft");
String inf_obj = contextResponse.getTemplate(inf_obj_template);

//проставим известные данные и возьмем нужный шаблон
response.setParam("service", service);
response.setParam("fromSystem", toSystem);
response.setParam("toSystem", fromSystem);
response.setParam("FromBranch", toBranch);
response.setParam("ToBranch", fromBranch);
response.setParam("message_id", MessageId_random);
response.setParam("corr_id",contextRequest.getRequest().getParam("message_id"));

response.setParam("inf_obj", inf_obj, "ESCAPE");
response = response.toString()

msgOut.writeString(response);
mqUtils.send("IIB.CFTADP.CRT.IN", msgOut);]]></script>
 </global>
</stubMQ>
